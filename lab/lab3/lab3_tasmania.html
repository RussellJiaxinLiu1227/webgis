<html>
<head>
  <title>Lab3: Web-based Mapping Using OpenLayers</title>
  <script src="https://cdn.jsdelivr.net/npm/ol@v7.1.0/dist/ol.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.1.0/ol.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol-layerswitcher@4.1.2/dist/ol-layerswitcher.css" />
  <script src="https://cdn.jsdelivr.net/npm/ol-layerswitcher@4.1.2/dist/ol-layerswitcher.js"></script>
</head>

<body>
  <h3>Lab3: Web-based Mapping Using OpenLayers</h3>
  <h4>Author: Jiaxin Liu</h4>
  <div id="map" class="map" style="width:800px; height:600px"></div>

  <script>
    // —— 底图 —— 
    var OSM = new ol.layer.Tile({
      title: 'OSM',
      type: 'base',
      visible: false,
      source: new ol.source.OSM()
    });

    var AZURE_KEY = '6srLl2o3dGC8xAqJVrOEtVGTFj1ujl40lKOoKJD6f1K3XLS2U5JAJQQJ99BIACYeBjFZ86DdAAAgAZMP4fGn';
    var azureRoad = new ol.layer.Tile({
      title: 'Azure Maps (Road)',
      type: 'base',
      visible: true,
      source: new ol.source.XYZ({
        url: 'https://atlas.microsoft.com/map/tile?api-version=2022-08-01'
           + '&tilesetId=microsoft.base.road&zoom={z}&x={x}&y={y}'
           + '&subscription-key=' + AZURE_KEY,
        crossOrigin: 'anonymous'
      })
    });

    // 底图分组（让 LayerSwitcher 以单选方式切换底图）
    var baseGroup = new ol.layer.Group({
      title: 'Base maps',
      layers: [azureRoad, OSM]
    });

    // —— WMS 叠加层（塔斯马尼亚）——
    var wmsUrl = 'https://data.stategrowth.tas.gov.au/geoserver/ows';

    var tasRoads = new ol.layer.Tile({
      title: 'Tas State Roads (ssg:GEO_CARRIAGEWAY)',
      visible: true,
      source: new ol.source.TileWMS({
        url: wmsUrl, // ✅ 用正确变量名
        params: {
          'LAYERS': 'ssg:GEO_CARRIAGEWAY',
          'TILED': true,
          'FORMAT': 'image/png',
          'TRANSPARENT': true,
          'VERSION': '1.3.0'
        },
        serverType: 'geoserver',
        transition: 0
      })
    });

    var tasCadastre = new ol.layer.Tile({
      title: 'Cadastre (pam:GEO_CADASTRE)',
      visible: false,
      source: new ol.source.TileWMS({
        url: wmsUrl,
        params: {
          'LAYERS': 'pam:GEO_CADASTRE',
          'TILED': true,
          'FORMAT': 'image/png',
          'TRANSPARENT': true,
          'VERSION': '1.3.0'
        },
        serverType: 'geoserver',
        transition: 0
      })
    });

    var tasBusTrips = new ol.layer.Tile({
      title: 'Bus Trips (ssg:GEO_BRM_TRIP)',
      visible: false,
      source: new ol.source.TileWMS({
        url: wmsUrl,
        params: {
          'LAYERS': 'ssg:GEO_BRM_TRIP',
          'TILED': true,
          'FORMAT': 'image/png',
          'TRANSPARENT': true,
          'VERSION': '1.3.0'
        },
        serverType: 'geoserver',
        transition: 0
      })
    });

    // —— 地图 —— 
    var map = new ol.Map({
      target: 'map',
      layers: [baseGroup, tasRoads, tasCadastre, tasBusTrips],
      view: new ol.View({
        center: [0, 0],   // 给个占位的有效值，随后用 fit 定位
        zoom: 2
      })
    });

    // 缩放到塔斯马尼亚范围（经纬度 -> Web Mercator）
    var tasExtent4326 = [143.5, -44.1, 148.6, -39.0]; // 略放宽
    var tasExtent3857 = ol.proj.transformExtent(tasExtent4326, 'EPSG:4326', 'EPSG:3857');
    map.getView().fit(tasExtent3857, { padding: [20, 20, 20, 20], duration: 300 });

    // 图层切换器
    map.addControl(new ol.control.LayerSwitcher({ tipLabel: 'Legend' }));
  </script>
</body>
</html>

